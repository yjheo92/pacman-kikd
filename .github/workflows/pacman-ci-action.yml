name: pacman-ci-action
env:
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ github.token }}
  APP_NAME: pacman
IMAGE_TAGS: 1.0.0 ${{ github.sha  }}
# Controls when the wrokflow will run
on: 
  push:
    branches:
      - main
  workflow_dispatch:
  jobs:
    build-and-push:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Set up JDK 11
          uses: actions/setup-java@v3
          with:
            distribution: 'adopt'
            java-version: '11'
            cache: 'maven'
        - name: Build with Maven
          run: mvn --batch-mode package
        - name: Buildah Action
          id: build-image
          uses: redhat-actions/buildah-build@v2
          with: 
            image: ${{ env.IMAGE_REGISTRY }}/${{ env.APP_NAME }}
            tags: ${{ env.IMAGE_TAGS }}
            containerfiles: |
              ./Dockerfile
        - name: Push to Registry
          id: push-to-registry
          uses: redhat-actions/push-to-registry@v2
          with:
            image: ${{ steps.build-image.outputs.image }}
            tags: ${{ steps.build-image.outputs.tags }}
            registry: ${{ env.IMAGE_REGISTRY }}
            username: ${{ env.REGISTRY_USER }}
            password: ${{ env.REGISTRY_PASSWORD }}